<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Excel con Gráfico</title>
    <!-- Biblioteca ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body>
    <script>
        // Obtener datos de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const data = urlParams.get("data") || "Columna1,Columna2,Columna3\nDato1,Dato2,Dato3";

        // Decodificar el contenido
        const decodedData = decodeURIComponent(data);

        // Convertir los datos en un array
        const rows = decodedData.split("\n").map(row => row.split(","));

        // Crear archivo Excel con ExcelJS
        async function generateExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet("Datos");

            // Agregar los datos al Excel
            rows.forEach(row => worksheet.addRow(row));

            // Insertar un módulo VBA
            workbook.vbaProject = workbook.addVBAProject();
            workbook.vbaProject.addModule("Module1", `
Sub AddChart()
    Dim ws As Worksheet
    Dim chartObj As ChartObject
    Set ws = ThisWorkbook.Sheets("Datos")

    ' Crear gráfico
    Set chartObj = ws.ChartObjects.Add(100, 100, 400, 300)
    With chartObj.Chart
        .ChartType = xlColumnClustered
        .SetSourceData ws.Range("C2:C" & ws.Cells(ws.Rows.Count, "C").End(xlUp).Row & ",G2:G" & ws.Cells(ws.Rows.Count, "G").End(xlUp).Row)
        .HasTitle = True
        .ChartTitle.Text = "Gráfico Generado"
        .Axes(xlCategory).HasTitle = True
        .Axes(xlCategory).AxisTitle.Text = "Eje X"
        .Axes(xlValue).HasTitle = True
        .Axes(xlValue).AxisTitle.Text = "Eje Y"
    End With
End Sub
            `);

            // Generar el archivo
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], {
                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            });

            // Descargar el archivo
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "archivo_con_grafico.xlsm";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        generateExcel();
    </script>
    <p>Generando archivo... Si la descarga no inicia, revisa la configuración del navegador.</p>
</body>
</html>
